input {
  snmp {
    hosts => {{ es_master_http }}
               { host => "udp:10.205.21.33/161" community => "DCN@viettel_aaa" version => "2c" retries => 2  timeout => 10000 }  
             ]
    add_field => {host => "%{[@metadata][host_protocol]}:%{[@metadata][host_address]}/%{[@metadata][host_port]},%{[@metadata][host_community]}"}
    add_field => {host_address => "%{[@metadata][host_address]}"}
    add_field => {host_community => "%{[@metadata][host_community]}"}
    get => ["1.3.6.1.2.1.1.3.0", "1.3.6.1.2.1.1.5.0", "1.3.6.1.2.1.1.1.0", "1.3.6.1.4.1.2636.3.4.2.2.2.0", "1.3.6.1.4.1.2636.3.4.2.3.2.0", "1.3.6.1.4.1.2636.3.1.13.1.7.9.1.0.0", "1.3.6.1.4.1.2636.3.1.13.1.8.9.1.0.0", "1.3.6.1.4.1.2636.3.1.13.1.11.9.1.0.0"]
    walk => ["1.3.6.1.4.1.2636.3.1.13.1.5", "1.3.6.1.4.1.2636.3.1.13.1.6", "1.3.6.1.2.1.25.2.3.1.3", "1.3.6.1.4.1.2636.3.1.13.1.8", "1.3.6.1.4.1.2636.3.1.13.1.11", "1.3.6.1.4.1.2636.3.1.13.1.7", "1.3.6.1.2.1.31.1.1.1.18", "1.3.6.1.2.1.31.1.1.1.1", "1.3.6.1.2.1.2.2.1.2", "1.3.6.1.2.1.2.2.1.21", "1.3.6.1.2.1.2.2.1.8", "1.3.6.1.2.1.2.2.1.7", "1.3.6.1.2.1.2.2.1.14", "1.3.6.1.2.1.2.2.1.20", "1.3.6.1.2.1.2.2.1.13", "1.3.6.1.2.1.2.2.1.19", "1.3.6.1.2.1.2.2.1.5", "1.3.6.1.2.1.31.1.1.1.15", "1.3.6.1.2.1.31.1.1.1.6", "1.3.6.1.2.1.31.1.1.1.10"]
    interval => 60
    tags => QFX_snmp
  }
}

filter {
  if "QFX_snmp" in [tags] {
    ruby {
      code => '
        list_field = event.to_hash
        file = File.open("/etc/logstash/dictionary/QFX_oid_mapping.txt", "r")
        data = file.readlines
        mapping_data = []
        data.each{ |item|
          data_split = item.split("=")
          mapping_data << { "name" => data_split[0], "oid" => data_split[1].sub("\r\n", "").sub("\n", "") }
        }
        list_field.each { |key, value|
          if (key =~ /iso.org/)
            mapping_data.each { |item|
              cut_string = key.sub(item["oid"], "")
              compare_key = key.sub(cut_string, "")
              if (compare_key == item["oid"])
                event.set(key.sub(item["oid"] + ".", item["name"] + "."), value)
                event.remove(key)
              end
              if (cut_string == "")
                event.set(key.sub(item["oid"], item["name"]), value)
                event.remove(key)
              end
            }
          end
        }
      '
    }

    ruby {
      code => '
        list_field = event.to_hash
        interface_mapping = []
        hardware_mapping = []
        list_field.each { |key, value|
          if (key =~ /interface.ifDescr/)
            interface_index = key.split(".")[-1]
            interface_mapping << { "index" => interface_index, "name" => value }
          end
          if (key =~ /healthcheck.jnxOperatingDescr/)
            hardware_index = key.sub("healthcheck.jnxOperatingDescr.", "")
            hardware_mapping << { "index" => hardware_index, "name" => value }
          end
        }

        list_field.each { |key, value|
          if (key =~ /interface.ifHCInOctets/ or key =~ /interface.ifHCOutOctets/ or key =~ /interface.ifOperStatus/ or key =~ /interface.ifAdminStatus/  or key =~ /interface.ifInErrors/ or key =~ /interface.ifOutErrors/ or key =~ /interface.ifInDiscards/ or key =~ /interface.ifOutDiscards/ or key =~ /interface.ifSpeed/ or key =~ /interface.ifHighSpeed/)
            index = key.split(".")[-1]
            interface_mapping.each { |item|
              if (item["index"] == index)
                replace_key =  key.gsub(/\.\d+$/, ".<" + item["name"] + ">" )
                event.set(replace_key, value)
                event.remove(key)
              end
            }
          end

          if (key =~ /linecard/ or key =~ /healthcheck.jnxOperatingState/)
            key_split = key.split(".")
            remove_string = key_split[0] + "." + key_split[1] + "."
            index = key.sub(remove_string, "")

            hardware_mapping.each { |item|
              if (item["index"] == index)
                replace_key =  key.sub(index, "<" + item["name"] + ">" )
                event.set(replace_key, value)
                event.remove(key)
              end
            }

          end
        }

      '
    }

  }
}

output {
  if "QFX_snmp" in [tags] {
    elasticsearch {
      hosts => {{ es_master_http }}
      index => "snmp-qfx"
      cacert => "/etc/logstash/certs/{{ inventory_hostname }}.pem"
      user => "{{ beats.logstash.logstash_writer.username }}"
      password => "{{ beats.logstash.logstash_writer.password }}"
      ssl_certificate_verification => false
    }
  }
}
